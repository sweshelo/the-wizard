# Phase 4: 最適化

## 目標

パフォーマンス、コスト、信頼性の最適化

## 前提条件

- Phase 3 が完了していること

## タスク一覧

| タスクID | タスク名 | 優先度 | 依存関係 | ステータス |
|----------|----------|--------|----------|------------|
| 4.1 | レイテンシ最適化 | P0 | Phase 3 | NOT_STARTED |
| 4.2 | コスト最適化 | P0 | 4.1 | NOT_STARTED |
| 4.3 | 並列推論 | P1 | 4.2 | NOT_STARTED |
| 4.4 | TOON形式実装 | P1 | 4.2 | NOT_STARTED |
| 4.5 | MCPサーバー実装 | P2 | 4.4 | NOT_STARTED |
| 4.6 | パフォーマンス計測・ダッシュボード | P2 | 4.3 | NOT_STARTED |

## 依存関係図

```
Phase 3 完了
    │
    └──▶ TASK-4.1 (レイテンシ最適化)
           │
           └──▶ TASK-4.2 (コスト最適化)
                   │
                   ├──▶ TASK-4.3 (並列推論)
                   │       │
                   │       └──▶ TASK-4.6 (計測・ダッシュボード)
                   │
                   └──▶ TASK-4.4 (TOON形式)
                           │
                           └──▶ TASK-4.5 (MCPサーバー)
```

---

## 詳細タスク

### TASK-4.1: レイテンシ最適化

**目的:** 応答時間の短縮

**成果物:**
- プロファイリング結果
- 最適化されたコード
- レイテンシ計測ユーティリティ

**テストケース (TDD):**
1. 通常操作 < 5秒
2. 選択肢応答 < 8秒
3. タイムアウト警告 < 1秒

**最適化ポイント:**
- API呼び出しの並列化
- キャッシュ活用
- 不要な処理の削除

---

### TASK-4.2: コスト最適化

**目的:** 1ゲームあたりのAPI費用を$2.00以下に

**成果物:**
- `/src/ai/CostTracker.ts`
- コスト分析レポート

**テストケース (TDD):**
1. トークン使用量の計測
2. コスト上限でのフォールバック
3. モデル選択最適化

**最適化ポイント:**
- Haikuの積極活用
- プロンプト圧縮
- 不要な分析の削減

---

### TASK-4.3: 並列推論

**目的:** 複数の判断を並列で実行

**成果物:**
- `/src/ai/ParallelInference.ts`

**テストケース (TDD):**
1. 独立した判断の並列実行
2. 結果の集約
3. エラー時のフォールバック

---

### TASK-4.4: TOON形式実装

**目的:** トークン効率を40-50%改善

**成果物:**
- `/src/ai/toon/encoder.ts`
- `/src/ai/toon/decoder.ts`
- `/src/ai/toon/gameState.ts`

**テストケース (TDD):**
1. JSON→TOON変換
2. TOON→JSON変換
3. ゲーム状態のTOON表現
4. トークン削減率の検証

---

### TASK-4.5: MCPサーバー実装

**目的:** カタログ・キーワード参照のMCP化

**成果物:**
- `/src/ai/catalog/CatalogTools.ts`
- MCP Tool定義

**テストケース (TDD):**
1. lookup_card ツール
2. lookup_keyword ツール
3. search_cards ツール
4. ツール呼び出しフロー

---

### TASK-4.6: パフォーマンス計測・ダッシュボード

**目的:** パフォーマンスの可視化と継続的改善

**成果物:**
- `/src/ai/metrics/MetricsCollector.ts`
- `/src/components/ai/AIPerformanceDashboard.tsx`

**テストケース (TDD):**
1. メトリクス収集
2. ダッシュボード表示
3. アラート機能

---

## 成功指標

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| タイムアウト率 | < 1% | ログ分析 |
| 通常操作平均応答時間 | < 3秒 | MetricsCollector |
| Opus使用時応答時間 | < 10秒 | MetricsCollector |
| 1ゲームあたりコスト | < $2.00 | CostTracker |
| 妥当な手の選択率 | > 90% | 手動評価 |
| ゲーム完了率 | > 99% | ログ分析 |

---

## 完了条件

- [ ] 全タスクのステータスが COMPLETED
- [ ] 全テストがパス
- [ ] 全成功指標を達成
- [ ] パフォーマンスダッシュボードで監視可能
